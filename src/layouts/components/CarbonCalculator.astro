---
// src/components/CarbonCalculator.astro

const productos = [
  { slug: "delantal", nombre: "Delantal", peso: 0.043, img: "/images/products/delantal.jpg" },
  { slug: "chaqueta", nombre: "Chaqueta", peso: 0.030, img: "/images/products/chaqueta.jpg" },
  { slug: "funda", nombre: "Funda Food Grade", peso: 0.025, img: "/images/products/funda.png" },
  { slug: "pantalon", nombre: "Pantalón", peso: 0.058, img: "/images/products/pantalon.jpg" },
  { slug: "mantilla", nombre: "Mantilla", peso: 0.046, img: "/images/products/mantilla.jpg" },
  { slug: "uniforme", nombre: "Uniforme", peso: 0.065, img: "/images/products/uniforme.jpg" },
  { slug: "lamina", nombre: "Lámina", peso: 0.021, img: "/images/products/lamina.png" },
  { slug: "pechera", nombre: "Pechera", peso: 0.035, img: "/images/products/pechera.jpg" },
];

const EF_CONV = 2.5; // kg CO₂e/kg plástico convencional
const EF_BIO = 2.2; // kg CO₂e/kg plástico Bioxiplas
---

<style>
  .product-card {
    border: 2px solid transparent;
    border-radius: 0.5rem;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
    background: none;
  }
  .product-card.selected {
    border-color: #10B981;
  }
  .product-card img {
    width: 100%;
    height: 120px;
    object-fit: cover;
  }
  .product-name {
    position: absolute;
    bottom: 0.5rem;
    left: 0.5rem;
    color: white;
    font-weight: 600;
    background-color: rgba(0, 0, 0, 0.5);
    padding: 0.25rem;
    border-radius: 0.25rem;
  }
</style>

<div class="mt-4 mx-auto p-4 border rounded-xl">

  <!-- Productos -->
  <div class="product-grid  grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
    {productos.map((producto) => (
      <button
        class="product-card relative"
        data-product-id={producto.slug}
        data-product-weight={producto.peso}
        onclick={`selectProduct('${producto.slug}')`}
      >
        <img src={producto.img} alt={producto.nombre} />
        <div class="product-name">{producto.nombre}</div>
      </button>
    ))}
  </div>

  <!-- Cantidad -->
  <div class="quantity-input mb-6">
    <label for="quantity" class="block mb-2">Cantidad:</label>
    <input
      type="number"
      id="quantity"
      min="1"
      value="1"
      class="w-full p-2 bg-body border border-white/10 rounded"
      oninput="calculateFootprint()"
    />
  </div>

  <!-- Resultados -->
  <div class="results-grid grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
    <div class="result-card p-4 bg-body border rounded-lg">
      <p class="text-sm mb-1">Convencional</p>
      <p id="conventional-result" class="text-xl font-bold">0.000</p>
      <p class="text-xs">kg CO₂e</p>
    </div>
    <div class="result-card p-4 bg-body border rounded-lg">
      <p class="text-sm mb-1">Bioxiplas</p>
      <p id="biox-result" class="text-xl font-bold">0.000</p>
      <p class="text-xs">kg CO₂e</p>
    </div>
    <div class="result-card p-4 bg-body border rounded-lg">
      <p class="text-sm mb-1">Ahorro</p>
      <p id="saving-result" class="text-xl font-bold">0.000</p>
      <p class="text-xs">kg CO₂e</p>
    </div>
  </div>

  <!-- Gráfico -->
  <div class="chart-container bg-body border p-4 rounded-lg">
    <canvas id="footprint-chart"></canvas>
  </div>
</div>

<script is:inline>
  // Factores de emisión
  const EF_CONV = 2.5;
  const EF_BIO = 2.2;
  
  // Variables globales
  let selectedProduct = {
    id: 'delantal',
    weight: 0.043
  };
  let footprintChart = null;

  // Inicializar al cargar la página
  document.addEventListener('DOMContentLoaded', function() {
    // Seleccionar primer producto por defecto
    selectProduct('delantal');
    
    // Inicializar gráfico
    initializeChart();
    
    // Calcular huella inicial
    calculateFootprint();
  });

  // Función para seleccionar producto
  function selectProduct(productId) {
    // Remover selección anterior
    document.querySelectorAll('.product-card').forEach(card => {
      card.classList.remove('selected');
    });
    
    // Agregar selección nueva
    const selectedCard = document.querySelector(`[data-product-id="${productId}"]`);
    selectedCard.classList.add('selected');
    
    // Actualizar producto seleccionado
    selectedProduct = {
      id: productId,
      weight: parseFloat(selectedCard.dataset.productWeight)
    };
    
    // Recalcular
    calculateFootprint();
  }

  // Función para calcular la huella
  function calculateFootprint() {
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    const weight = selectedProduct.weight;
    
    const conventional = (weight * quantity * EF_CONV).toFixed(3);
    const biox = (weight * quantity * EF_BIO).toFixed(3);
    const saving = (conventional - biox).toFixed(3);
    
    // Actualizar resultados
    document.getElementById('conventional-result').textContent = conventional;
    document.getElementById('biox-result').textContent = biox;
    document.getElementById('saving-result').textContent = saving;
    
    // Actualizar gráfico
    if (footprintChart) {
      footprintChart.data.datasets[0].data = [conventional, biox];
      footprintChart.update();
    }
  }

  // Función para inicializar el gráfico
  function initializeChart() {
    const ctx = document.getElementById('footprint-chart').getContext('2d');
    
    footprintChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Convencional', 'Bioxiplas'],
        datasets: [{
          label: 'Emisiones (kg CO₂e)',
          data: [0, 0],
          backgroundColor: [
            'rgba(239, 68, 68, 0.7)', // Rojo
            'rgba(16, 185, 129, 0.7)'  // Verde
          ],
          borderColor: [
            'rgba(239, 68, 68, 1)',
            'rgba(16, 185, 129, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }
</script>