---
// src/components/CarbonCalculator.astro

const productos = [
  { slug: "delantal", nombre: "Delantal", peso: 0.043, img: "/images/products/delantal.jpg" },
  { slug: "chaqueta", nombre: "Chaqueta", peso: 0.030, img: "/images/products/chaqueta.jpg" },
  { slug: "funda", nombre: "Funda Food Grade", peso: 0.025, img: "/images/products/funda.png" },
  { slug: "pantalon", nombre: "Pantalón", peso: 0.058, img: "/images/products/pantalon.jpg" },
  { slug: "mantilla", nombre: "Mantilla", peso: 0.046, img: "/images/products/mantilla.jpg" },
  { slug: "uniforme", nombre: "Uniforme", peso: 0.065, img: "/images/products/uniforme.jpg" },
  { slug: "lamina", nombre: "Lámina", peso: 0.021, img: "/images/products/lamina.png" },
  { slug: "pechera", nombre: "Pechera", peso: 0.035, img: "/images/products/pechera.jpg" },
];

const EF_CONV = 2.5; // kg CO₂e/kg plástico convencional
const EF_BIO  = 2.2; // kg CO₂e/kg plástico Bioxiplas
---
<style>
  .product-card {
    border: 2px solid transparent;
    border-radius: 0.5rem;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
    background: none;
  }
  .product-card.selected {
    border-color: #10B981;
  }
  .product-card img {
    width: 100%;
    height: 120px;
    object-fit: cover;
  }
  .product-name {
    position: absolute;
    bottom: 0.5rem;
    left: 0.5rem;
    color: white;
    font-weight: 600;
    background-color: rgba(0, 0, 0, 0.5);
    padding: 0.25rem;
    border-radius: 0.25rem;
  }
</style>

<div class="mt-4 mx-auto p-4 border rounded-xl">

  <!-- Productos -->
  <div class="product-grid grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
    {productos.map((producto) => (
      <button
        class="product-card relative hover:-translate-y-1"
        data-product-id={producto.slug}
        data-product-weight={producto.peso}
        onclick={`selectProduct('${producto.slug}')`}
      >
        <img src={producto.img} alt={producto.nombre} />
        <div class="product-name">{producto.nombre}</div>
      </button>
    ))}
  </div>

  <!-- Cantidad -->
  <div class="quantity-input mb-6">
    <label for="quantity" class="block mb-2">Cantidad:</label>
    <input
      type="number"
      id="quantity"
      min="1"
      value="1"
      class="w-full p-2 bg-body border border-white/10 rounded"
      oninput="calculateFootprint()"
    />
  </div>

  <!-- Resultados -->
  <div class="results-grid grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
    <div class="result-card p-4 bg-body border rounded-lg">
      <p class="text-sm mb-1">Convencional</p>
      <p id="conventional-result" class="text-xl font-bold">0.000</p>
      <p class="text-xs">kg CO₂e</p>
    </div>
    <div class="result-card p-4 bg-body border rounded-lg">
      <p class="text-sm mb-1">Bioxiplas</p>
      <p id="biox-result" class="text-xl font-bold">0.000</p>
      <p class="text-xs">kg CO₂e</p>
    </div>
    <div class="result-card p-4 bg-body border rounded-lg">
      <p class="text-sm mb-1">Ahorro</p>
      <p id="saving-result" class="text-xl font-bold">0.000</p>
      <p class="text-xs">kg CO₂e</p>
    </div>
  </div>

  <!-- Gráfico -->
  <div class="chart-container bg-body border p-4 rounded-lg">
    <canvas id="footprint-chart"></canvas>
  </div>
</div>

<!-- Carga de Chart.js desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script is:inline>
  // Factores de emisión (se declaran de nuevo para el entorno cliente)
  const EF_CONV = 2.5;
  const EF_BIO  = 2.2;

  // Estado global
  let selectedProduct = { id: 'delantal', weight: 0.043 };
  let footprintChart = null;

  // Al cargar la página
  document.addEventListener('DOMContentLoaded', () => {
    selectProduct('delantal');
    initializeChart();
    calculateFootprint();
  });

  // Seleccionar producto
  function selectProduct(productId) {
    document.querySelectorAll('.product-card').forEach(c => c.classList.remove('selected'));
    const card = document.querySelector(`[data-product-id="${productId}"]`);
    card.classList.add('selected');
    selectedProduct = {
      id: productId,
      weight: parseFloat(card.dataset.productWeight)
    };
    calculateFootprint();
  }

  // Calcular huella
  function calculateFootprint() {
    const qty = parseInt(document.getElementById('quantity').value) || 1;
    const conv = selectedProduct.weight * qty * EF_CONV;
    const bio  = selectedProduct.weight * qty * EF_BIO;
    const save = conv - bio;

    document.getElementById('conventional-result').textContent = conv.toFixed(3);
    document.getElementById('biox-result').textContent = bio.toFixed(3);
    document.getElementById('saving-result').textContent = save.toFixed(3);

    if (footprintChart) {
      footprintChart.data.datasets[0].data = [conv, bio];
      footprintChart.update();
    }
  }

  // Inicializar gráfico
  function initializeChart() {
    const ctx = document.getElementById('footprint-chart').getContext('2d');
    footprintChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Convencional', 'Bioxiplas'],
        datasets: [{
          label: 'Emisiones (kg CO₂e)',
          data: [0, 0],
          backgroundColor: [
            'rgba(239, 68, 68, 0.7)',
            'rgba(16, 185, 129, 0.7)'
          ],
          borderColor: [
            'rgba(239, 68, 68, 1)',
            'rgba(16, 185, 129, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
</script>
