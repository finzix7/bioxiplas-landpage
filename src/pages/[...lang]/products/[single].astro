---
import CallToAction from "@/components/sections/CallToAction.astro";
import Base from "@/layouts/Base.astro";
import parseTomlToJson from "@/lib/utils/parseTomlToJson";
import { useTranslations } from "@/lib/utils/languageParser.ts";
import SinglePageLayout from "@/components/SinglePageLayout.astro";
import { markdownify } from "@/lib/utils/textConverter";
import { fetchProductBySlug } from "@/lib/payload";

export const prerender = false;

const { single } = Astro.params;
const config = parseTomlToJson("@/config/config.toml");
const product = await fetchProductBySlug(single, Astro.currentLocale);

const translations = await useTranslations(Astro.currentLocale as string);

let contentHtml = "";
if (product) {
  if (product.descripcion) {
    contentHtml += `## Descripción\n${product.descripcion}\n`;
  }
  if (product.caracteristicas) {
    contentHtml += `\n### Características\n${product.caracteristicas}\n`;
  }
  if (product.usos) {
    contentHtml += `\n### Usos\n${product.usos}\n`;
  }
  if (product.como_solicitar) {
    contentHtml += `\n### ¿Cómo solicitar?\n${product.como_solicitar}\n`;
  }
  contentHtml = markdownify(contentHtml, true) as string;
}
---

<Base {...(product || {})}>
  <SinglePageLayout
    layout={"modern"}
    translations={translations}
    content={{
      ...product,
      Content: contentHtml,
    }}
  />
  <CallToAction />
</Base>
