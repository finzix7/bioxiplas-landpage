---
import Base from "@/layouts/Base.astro";
import SinglePageLayout from "@/components/SinglePageLayout.astro";
import CallToAction from "@/components/sections/CallToAction.astro";
import { supportedLanguages, useTranslations } from "@/lib/utils/languageParser.ts";
import parseTomlToJson from "@/lib/utils/parseTomlToJson";
import { fetchCertifications } from "@/lib/payload";
import { markdownify } from "@/lib/utils/textConverter";

export async function getStaticPaths() {
  const config = parseTomlToJson("./src/config/config.toml");
  const { default_language } = config.settings.multilingual;
  const all = supportedLanguages.map((l) => l.languageCode);

  const paths = [{ params: { lang: undefined } }];
  all
    .filter((code) => code !== default_language)
    .forEach((code) => paths.push({ params: { lang: code } }));

  return paths;
}

const locale = Astro.currentLocale || "es";
const pageData = await fetchCertifications({ locale });
const translations = await useTranslations(locale);
const certificates = pageData?.docs || [];

// Construcción dinámica del contenido en markdown
let contentMd = `## Nuestras Certificaciones\n\n`;
// Detectar idioma y ajustar contenido
if (locale === 'en') {
  contentMd = `## Our Certifications\n\n`;
} else if (locale === 'de') {
  contentMd = `## Unsere Zertifizierungen\n\n`;
}

for (const cert of certificates) {
  if (cert.title) contentMd += `### ${cert.title}\n`;
  if (cert.image_url)
    contentMd += `<img src="${cert.image_url}" alt="${cert.title}" class="max-w-72 mx-auto mb-2" />\n`;
  if (cert.description) {
    contentMd += markdownify(cert.description, true) + '\n\n';
  };
}

if (certificates.length === 0) {
  contentMd += `No certifications available at the moment.`;
}

contentMd += `\n\n---\n\n`;
// Añadir un pie de página o nota adicional
if (locale === 'en') {
  contentMd += "With these certifications and tests, Bioxiplas ensures that each product is **safe**, **reliable**, and **environmentally friendly**.";
} else if (locale === 'de') {
  contentMd += "Mit diesen Zertifizierungen und Tests stellt Bioxiplas sicher, dass jedes Produkt **sicher**, **zuverlässig** und **umweltfreundlich** ist.";
} else {
  contentMd += "Con estas certificaciones y ensayos, Bioxiplas asegura que cada producto es **seguro**, **confiable** y **respetuoso con el medio ambiente**.";
}

// Markdown a HTML
let contentHtml = markdownify(contentMd, true) as string;
---

<Base {...pageData}>
  <SinglePageLayout
    layout="modern"
    translations={translations}
    content={{
      ...pageData,
      Content: contentHtml,
    }}
  />
  <CallToAction />
</Base>
